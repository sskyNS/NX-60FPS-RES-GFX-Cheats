name: Simple Sync and Release

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  sync-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Configure Git
      run: |
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"
        
    - name: Sync from upstream
      run: |
        git remote add upstream https://github.com/ChanseyIsTheBest/NX-60FPS-RES-GFX-Cheats.git || true
        git fetch upstream
        git merge upstream/main --allow-unrelated-histories -m "Auto-sync from upstream $(date +'%Y-%m-%d %H:%M:%S')" || true
        git push origin main || true
        
    - name: Package titles directory
      id: package
      run: |
        echo "当前目录结构:"
        ls -la
        
        echo "检查titles目录:"
        if [ -d "titles" ]; then
          echo "titles目录存在，包含文件:"
          find titles -type f | head -20
          
          # 创建版本号
          TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
          VERSION="v1.0.$TIMESTAMP"
          
          # 创建压缩包
          ZIP_NAME="NX-60FPS-RES-GFX-Cheats-${TIMESTAMP}.zip"
          echo "正在创建压缩包: $ZIP_NAME"
          
          # 使用更详细的压缩命令
          zip -r "$ZIP_NAME" titles/ -v
          
          # 检查文件是否创建成功
          echo "压缩包创建完成，文件信息:"
          ls -lh "$ZIP_NAME"
          
          # 保存到环境变量
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "ZIP_PATH=$(pwd)/$ZIP_NAME" >> $GITHUB_ENV
          
          echo "::set-output name=zip_name::$ZIP_NAME"
          echo "::set-output name=version::$VERSION"
        else
          echo "错误: titles目录不存在!"
          exit 1
        fi
        
    - name: Debug - Show environment
      run: |
        echo "ZIP_NAME: $ZIP_NAME"
        echo "VERSION: $VERSION"
        echo "当前目录:"
        pwd
        ls -la
        
    - name: Create Release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # 使用GitHub CLI创建发布
        echo "正在创建发布 $VERSION..."
        
        # 首先检查release是否已存在
        if gh release view "$VERSION" >/dev/null 2>&1; then
          echo "Release $VERSION 已存在，删除旧版本..."
          gh release delete "$VERSION" -y
        fi
        
        # 创建新发布
        gh release create "$VERSION" \
          --title "NX-60FPS-RES-GFX-Cheats $VERSION" \
          --notes "自动同步和构建版本 - $TIMESTAMP" \
          "$ZIP_NAME"
          
        echo "Release $VERSION 创建成功!"
