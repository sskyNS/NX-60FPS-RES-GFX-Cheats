name: Simple Sync and Release

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  sync-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Configure Git
      run: |
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"
        
    - name: Sync from upstream
      id: sync
      run: |
        # 添加上游仓库
        git remote add upstream https://github.com/ChanseyIsTheBest/NX-60FPS-RES-GFX-Cheats.git || true
        
        # 获取上游更新
        echo "正在获取上游更新..."
        git fetch upstream
        
        # 检查是否有新内容需要合并
        echo "检查上游是否有新提交..."
        LOCAL_HASH=$(git rev-parse HEAD)
        UPSTREAM_HASH=$(git rev-parse upstream/main)
        
        if [ "$LOCAL_HASH" != "$UPSTREAM_HASH" ]; then
          echo "检测到上游有新提交，正在合并..."
          
          # 尝试合并，优先使用本地版本
          if ! git merge upstream/main --no-commit; then
            echo "存在冲突，以我们的版本为准..."
            git checkout --ours .
            git add .
          fi
          
          # 提交合并
          git commit -m "Auto-sync from upstream $(date +'%Y-%m-%d %H:%M:%S')" || true
          
          # 推送到origin
          echo "正在推送到origin..."
          git push origin main
          
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "upstream_hash=$UPSTREAM_HASH" >> $GITHUB_OUTPUT
        else
          echo "上游已是最新，无需同步。"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Package titles directory
      id: package
      run: |
        echo "当前目录结构:"
        ls -la
        
        echo "检查titles目录:"
        if [ -d "titles" ]; then
          echo "titles目录存在，包含文件:"
          find titles -type f | head -20
          
          # 创建版本号（仅用于发布标签）
          TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
          VERSION="v1.0.$TIMESTAMP"
          
          # 创建压缩包 - 使用固定名称NX-60FPS-RES-GFX-Cheats.zip
          ZIP_NAME="NX-60FPS-RES-GFX-Cheats.zip"
          echo "正在创建压缩包: $ZIP_NAME"
          
          # 删除旧版本的同名文件（如果存在）
          rm -f "$ZIP_NAME"
          
          # 创建新的压缩包
          zip -r "$ZIP_NAME" titles/ -v
          
          # 检查文件是否创建成功
          echo "压缩包创建完成，文件信息:"
          ls -lh "$ZIP_NAME"
          
          # 保存到环境变量
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV
        else
          echo "错误: titles目录不存在!"
          exit 1
        fi
        
    - name: Install GitHub CLI
      run: |
        # 安装GitHub CLI
        sudo apt-get update
        sudo apt-get install -y gh
        
    - name: Create Release
      # 只有有更新或手动触发时才创建发布
      if: steps.sync.outputs.has_changes == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'push'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # 使用GitHub CLI创建发布
        echo "正在创建发布 ${{ env.VERSION }}..."
        
        # 检查release是否已存在
        echo "检查是否已存在同名发布..."
        if gh release view "${{ env.VERSION }}" --repo "$GITHUB_REPOSITORY" >/dev/null 2>&1; then
          echo "Release ${{ env.VERSION }} 已存在，删除旧版本..."
          gh release delete "${{ env.VERSION }}" --repo "$GITHUB_REPOSITORY" -y
        fi
        
        # 创建新发布
        echo "正在创建新发布..."
        gh release create "${{ env.VERSION }}" \
          --title "NX-60FPS-RES-GFX-Cheats ${{ env.VERSION }}" \
          --notes "自动同步和构建版本 - ${{ env.TIMESTAMP }}
          
          上游仓库: https://github.com/ChanseyIsTheBest/NX-60FPS-RES-GFX-Cheats
          同步时间: $(date)
           
          压缩包包含最新的titles目录内容，文件名为NX-60FPS-RES-GFX-Cheats.zip" \
          "${{ env.ZIP_NAME }}" \
          --repo "$GITHUB_REPOSITORY"
          
        echo "Release ${{ env.VERSION }} 创建成功!"
        
    - name: Clean up
      if: always()
      run: |
        # 清理临时文件（可选，如果需要保留最新的zip文件可以注释掉这行）
        # echo "清理临时文件..."
        # rm -f NX-60FPS-RES-GFX-Cheats.zip || true
