name: Simple Sync and Release

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  sync-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Configure Git
      run: |
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"
        
    - name: Sync from upstream
      id: sync
      run: |
        # 添加上游仓库
        git remote add upstream https://github.com/ChanseyIsTheBest/NX-60FPS-RES-GFX-Cheats.git || true
        
        # 获取上游更新
        echo "正在获取上游更新..."
        git fetch upstream
        
        # 检查是否有新内容需要合并
        echo "检查上游是否有新提交..."
        LOCAL_HASH=$(git rev-parse HEAD)
        UPSTREAM_HASH=$(git rev-parse upstream/main)
        
        if [ "$LOCAL_HASH" != "$UPSTREAM_HASH" ]; then
          echo "检测到上游有新提交，正在合并..."
          
          # 尝试合并，优先使用本地版本
          if ! git merge upstream/main --no-commit; then
            echo "存在冲突，以我们的版本为准..."
            git checkout --ours .
            git add .
          fi
          
          # 提交合并
          git commit -m "Auto-sync from upstream $(date +'%Y-%m-%d %H:%M:%S')" || true
          
          # 推送到origin
          echo "正在推送到origin..."
          git push origin main
          
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "upstream_hash=$UPSTREAM_HASH" >> $GITHUB_OUTPUT
        else
          echo "上游已是最新，无需同步。"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Package titles directory
      id: package
      run: |
        echo "当前目录结构:"
        ls -la
        
        echo "检查titles目录:"
        if [ -d "titles" ]; then
          echo "titles目录存在，包含文件:"
          find titles -type f | head -20
          
          # 创建版本号（用于历史记录）
          TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
          VERSION="v1.0.$TIMESTAMP"
          
          # 创建压缩包 - 使用固定名称NX-60FPS-RES-GFX-Cheats.zip
          ZIP_NAME="NX-60FPS-RES-GFX-Cheats.zip"
          echo "正在创建压缩包: $ZIP_NAME"
          
          # 删除旧版本的同名文件（如果存在）
          rm -f "$ZIP_NAME"
          
          # 创建新的压缩包
          zip -r "$ZIP_NAME" titles/ -v
          
          # 检查文件是否创建成功
          echo "压缩包创建完成，文件信息:"
          ls -lh "$ZIP_NAME"
          
          # 保存到环境变量
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV
        else
          echo "错误: titles目录不存在!"
          exit 1
        fi
        
    - name: Install GitHub CLI
      run: |
        # 安装GitHub CLI
        sudo apt-get update
        sudo apt-get install -y gh
        
    - name: Create Historical Release
      # 只有有更新或手动触发时才创建历史发布
      if: steps.sync.outputs.has_changes == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'push'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # 创建带时间戳的历史版本（用于记录）
        echo "正在创建历史发布 ${{ env.VERSION }}..."
        gh release create "${{ env.VERSION }}" \
          --title "NX-60FPS-RES-GFX-Cheats (历史版本 ${{ env.TIMESTAMP }})" \
          --notes "历史构建版本，归档用
          
          构建时间: ${{ env.TIMESTAMP }}
          上游提交哈希: ${{ steps.sync.outputs.upstream_hash }}" \
          "${{ env.ZIP_NAME }}" \
          --repo "$GITHUB_REPOSITORY"
          
        echo "历史发布 ${{ env.VERSION }} 创建成功!"
        
    - name: Create/Update Latest Release
      # 无论有无更新，只要运行到这一步，就更新latest发布
      if: steps.sync.outputs.has_changes == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'push'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "正在创建/更新 'latest' 发布..."
        
        # 检查是否已存在名为 'latest' 的发布
        if gh release view "latest" --repo "$GITHUB_REPOSITORY" >/dev/null 2>&1; then
          echo "找到现有的 'latest' 发布，正在更新..."
          # 删除现有的latest发布
          gh release delete "latest" --repo "$GITHUB_REPOSITORY" -y
        fi
        
        # 创建新的latest发布（使用--latest标志将其标记为最新）
        gh release create "latest" \
          --title "NX-60FPS-RES-GFX-Cheats (最新版)" \
          --notes "**最新版本** - 自动同步自上游
          
          更新时间: $(date)
          上游仓库: https://github.com/ChanseyIsTheBest/NX-60FPS-RES-GFX-Cheats
          固定下载链接: https://github.com/$GITHUB_REPOSITORY/releases/download/latest/NX-60FPS-RES-GFX-Cheats.zip
          
          注意: 此链接始终指向最新版本。" \
          "${{ env.ZIP_NAME }}" \
          --repo "$GITHUB_REPOSITORY" \
          --latest
          
        echo "'latest' 发布创建/更新成功!"
        echo "固定下载链接: https://github.com/$GITHUB_REPOSITORY/releases/download/latest/NX-60FPS-RES-GFX-Cheats.zip"
        
    - name: Clean up
      if: always()
      run: |
        # 清理临时文件
        echo "清理临时文件..."
        rm -f NX-60FPS-RES-GFX-Cheats.zip || true
